# 旅行计划编辑功能说明

## 功能概述

现在用户可以编辑已生成的旅行计划，包括修改景点、地点、时间、描述等信息。特别地，当修改地点信息后，地图会自动更新并正确显示新的地点位置。

## 实现的功能

### 1. 后端API改进
- ✅ 添加了 `TravelPlanUpdate` schema，支持灵活更新旅行计划的各个字段
- ✅ 改进了 `PUT /travel/plans/{plan_id}` 接口，支持更新行程（itinerary）数据
- ✅ 自动重新计算天数（当修改日期时）

### 2. 前端API调用
- ✅ 添加了 `updateTravelPlan()` 方法，用于更新旅行计划

### 3. 编辑界面
- ✅ 在行程详情页添加了"编辑行程"按钮
- ✅ 实现了编辑模式切换功能
- ✅ 为每个活动项添加了可编辑的输入框：
  - 时间
  - 活动名称
  - 地点（重要：修改后会在地图上更新）
  - 描述
  - 时长
  - 预计费用

### 4. 编辑模式功能
- ✅ **进入编辑模式**：点击"编辑行程"按钮
  - 所有字段变为可编辑状态
  - 显示"保存修改"和"取消"按钮
  - 保存原始数据以便取消时恢复

- ✅ **保存修改**：点击"保存修改"按钮
  - 收集所有修改的数据
  - 调用后端API更新旅行计划
  - 重新显示行程
  - **自动更新地图标记**（如果修改了地点）

- ✅ **取消编辑**：点击"取消"按钮
  - 恢复原始数据
  - 退出编辑模式

### 5. 地图自动更新
- ✅ 当保存修改后，`displayItinerary()` 方法会被重新调用
- ✅ `displayItinerary()` 会调用 `mapManager.showItineraryOnMap()`
- ✅ 地图会清除旧标记，根据新的地点信息重新搜索并标注
- ✅ 支持通过POI搜索和地理编码两种方式定位新地点

### 6. 样式优化
- ✅ 编辑模式下输入框有明显的蓝色边框
- ✅ 聚焦时有高亮效果
- ✅ 编辑模式下的活动项有特殊背景色
- ✅ 响应式设计，移动端友好

## 使用方法

1. **查看旅行计划**
   - 在"我的计划"页面选择一个计划
   - 或者创建新的旅行计划

2. **编辑行程**
   - 点击行程顶部的"✏️ 编辑行程"按钮
   - 修改需要调整的内容（特别是地点信息）
   - 点击"💾 保存修改"按钮

3. **地点修改示例**
   - 原地点：南京博物院
   - 修改为：南京总统府
   - 保存后，地图会自动搜索"南京总统府"并更新标记位置

4. **取消编辑**
   - 如果不想保存修改，点击"❌ 取消"按钮
   - 所有修改会被撤销

## 技术实现细节

### 地点更新流程

```
用户修改地点 
  ↓
点击保存
  ↓
收集DOM中的修改数据
  ↓
更新poi_name（如果活动名称改变）
  ↓
调用API更新后端数据
  ↓
重新调用displayItinerary()
  ↓
调用mapManager.showItineraryOnMap()
  ↓
清除旧标记
  ↓
使用新地点搜索POI
  ↓
在地图上添加新标记
  ↓
绘制路径
```

### 关键代码位置

1. **后端**
   - `backend/schemas.py` - TravelPlanUpdate schema
   - `backend/routers/travel_router.py` - 更新旅行计划的PUT接口

2. **前端**
   - `frontend/js/api.js` - updateTravelPlan() 方法
   - `frontend/js/travel.js` - 编辑模式相关方法
     - setupEditMode()
     - toggleEditMode()
     - saveItinerary()
   - `frontend/css/style.css` - 编辑模式样式

3. **地图更新**
   - `frontend/js/map.js` - showItineraryOnMap() 自动更新标记

## 注意事项

1. **地点格式**
   - 建议使用完整的地点名称（如"南京夫子庙"而不是"夫子庙"）
   - 系统会自动在城市范围内搜索

2. **保存提示**
   - 修改后必须点击"保存修改"才会生效
   - 取消操作会丢失所有未保存的修改

3. **地图更新**
   - 地图更新需要调用高德地图API
   - 如果地点名称不存在，可能无法在地图上显示
   - 建议使用知名景点或标志性建筑名称

## 未来可能的改进

- [ ] 添加删除活动功能
- [ ] 添加新增活动功能
- [ ] 支持拖拽排序活动
- [ ] 支持批量编辑
- [ ] 添加撤销/重做功能
- [ ] 地点自动补全建议

## 测试建议

1. 创建一个测试旅行计划
2. 进入编辑模式
3. 修改某个景点的地点信息
4. 保存修改
5. 检查地图上的标记是否正确更新
6. 测试取消功能是否正确恢复数据

