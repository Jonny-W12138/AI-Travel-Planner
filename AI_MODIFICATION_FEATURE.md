# AI智能修改行程功能说明

## 功能概述

现在用户可以直接向AI提出修改意见，用自然语言描述想要的调整，AI会智能地优化和修改整个旅行计划。这是一个比手动编辑更强大、更智能的功能。

## 两种编辑方式对比

### 1. 手动编辑（已有功能）
- ✏️ 点击"手动编辑"按钮
- 逐个字段修改（时间、地点、描述等）
- 适合小幅度的精确调整
- 需要自己确保行程的合理性

### 2. AI智能修改（新功能）🌟
- 🤖 在"向AI提出修改意见"输入框中用自然语言描述需求
- AI自动理解意图并重新规划整个行程
- 适合大幅度的调整和优化
- AI确保修改后的行程合理可行
- **自动更新地图标记**

## 使用示例

### 示例1：增加特定类型景点
```
用户输入：
我想第二天增加更多历史文化景点，比如博物馆和古建筑

AI响应：
✅ 自动调整第二天的行程
✅ 添加当地著名的博物馆和古建筑
✅ 重新安排时间和顺序
✅ 更新地图上的标记位置
```

### 示例2：调整预算档次
```
用户输入：
希望降低住宿预算，推荐经济型酒店，预算控制在200元/晚以内

AI响应：
✅ 替换所有酒店为经济型选择
✅ 更新预算分析
✅ 确保酒店仍在合理位置
✅ 地图自动显示新酒店位置
```

### 示例3：更换活动类型
```
用户输入：
第三天想改成户外活动，不要室内景点

AI响应：
✅ 将第三天改为户外活动
✅ 推荐登山、徒步、公园等
✅ 调整餐厅位置（靠近户外活动区）
✅ 重新规划路线
```

### 示例4：美食偏好调整
```
用户输入：
能否推荐一些当地特色美食餐厅？我对海鲜过敏，请避免海鲜餐厅

AI响应：
✅ 更新所有餐厅推荐
✅ 只推荐本地特色餐厅
✅ 避开海鲜类餐厅
✅ 标注特色菜品
✅ 地图上更新餐厅位置
```

## 技术实现

### 后端架构

1. **AI服务层** (`backend/services/ai_service.py`)
   - 新增 `modify_itinerary_with_feedback()` 方法
   - 接收当前行程和用户反馈
   - 调用阿里云百炼大模型（通义千问）
   - 返回完整的优化后行程

2. **API路由** (`backend/routers/travel_router.py`)
   - 新增 `POST /travel/plans/{plan_id}/modify-with-ai` 端点
   - 验证用户权限
   - 调用AI服务
   - 更新数据库

3. **数据模型** (`backend/schemas.py`)
   - 新增 `ItineraryModificationRequest` schema
   - 接收用户的修改意见

### 前端实现

1. **用户界面** (`frontend/js/travel.js`)
   - 在行程详情页添加AI修改输入框
   - 提供示例提示文本
   - 实时反馈处理状态

2. **API调用** (`frontend/js/api.js`)
   - 新增 `modifyPlanWithAI()` 方法
   - 发送反馈到后端
   - 接收优化后的行程

3. **样式设计** (`frontend/css/style.css`)
   - 渐变背景设计
   - 响应式布局
   - 聚焦动画效果

### AI提示词设计

AI收到的信息包括：
- 当前完整的行程JSON
- 目的地、天数、预算等基本信息
- 用户的修改意见

AI被要求：
- 只修改用户提到的部分
- 保持其他部分合理性
- 确保所有POI都有精确的名称用于地图搜索
- 返回完整的JSON格式行程

## 工作流程

```
用户查看旅行计划
    ↓
在输入框中描述修改意见
    ↓
点击"让AI优化行程"按钮
    ↓
前端发送请求到后端API
    ↓
后端调用AI服务
    ↓
AI分析当前行程和用户意见
    ↓
AI生成优化后的完整行程
    ↓
后端保存到数据库
    ↓
返回优化后的行程给前端
    ↓
前端重新渲染行程
    ↓
地图自动更新标记位置
    ↓
显示成功提示
```

## 地图自动更新

当AI修改行程后：
1. ✅ 前端调用 `displayItinerary()` 重新渲染
2. ✅ 自动调用 `mapManager.showItineraryOnMap()`
3. ✅ 清除旧的地图标记
4. ✅ 根据新的POI名称搜索位置
5. ✅ 在地图上添加新标记
6. ✅ 重新绘制路径连接

这意味着：
- **景点改变**：地图显示新景点位置
- **餐厅更换**：地图显示新餐厅位置
- **酒店调整**：地图显示新酒店位置
- **路径更新**：自动规划新的驾车路线

## 使用技巧

### 1. 明确具体的需求
❌ 不好："改一下行程"
✅ 好："第二天增加3个博物馆，减少购物时间"

### 2. 提供偏好信息
❌ 不好："换个餐厅"
✅ 好："推荐川菜餐厅，人均100元左右，带孩子适合"

### 3. 说明预算限制
❌ 不好："便宜点"
✅ 好："住宿预算降低到150-250元/晚，推荐连锁酒店"

### 4. 指定调整范围
❌ 不好："增加景点"
✅ 好："只修改第三天和第四天，增加自然景观类景点"

## 优势对比

| 特性 | 手动编辑 | AI智能修改 |
|------|---------|-----------|
| 操作方式 | 逐个字段修改 | 自然语言描述 |
| 修改范围 | 单个字段 | 整体优化 |
| 合理性检查 | 手动确认 | AI自动确保 |
| 地图更新 | 自动 | 自动 |
| 适用场景 | 小调整 | 大幅调整 |
| 学习成本 | 需要理解结构 | 说人话即可 |
| 速度 | 较慢 | 快速 |

## API文档

### 请求格式

```http
POST /travel/plans/{plan_id}/modify-with-ai
Authorization: Bearer {token}
Content-Type: application/json

{
  "feedback": "用户的修改意见文本"
}
```

### 响应格式

```json
{
  "id": 1,
  "user_id": 1,
  "title": "南京 5天游",
  "destination": "南京",
  "start_date": "2025-11-10T00:00:00",
  "end_date": "2025-11-14T00:00:00",
  "days": 5,
  "budget": 3000.0,
  "travelers_count": 2,
  "preferences": "喜欢历史文化",
  "itinerary": {
    "overview": "优化后的行程概述...",
    "daily_itinerary": [...],
    "transportation": {...},
    "accommodation_summary": {...},
    "restaurant_recommendations": [...],
    "budget_breakdown": {...},
    "tips": [...]
  },
  "budget_breakdown": {...},
  "created_at": "2025-11-06T10:00:00",
  "updated_at": "2025-11-06T11:30:00"
}
```

## 错误处理

- ✅ 输入框为空时提示用户
- ✅ AI调用失败时显示详细错误信息
- ✅ 网络错误时自动重试提示
- ✅ 权限验证失败时跳转登录

## 性能优化

- ✅ 加载中显示友好的等待提示
- ✅ AI生成过程中显示"正在优化"动画
- ✅ 成功后立即刷新页面显示新内容
- ✅ 输入框在提交后自动清空

## 安全性

- ✅ 用户只能修改自己的旅行计划
- ✅ 所有请求都需要JWT身份验证
- ✅ AI返回内容经过格式验证
- ✅ 防止注入攻击和恶意输入

## 未来改进方向

- [ ] 支持语音输入修改意见
- [ ] 添加"撤销"功能，保存修改历史
- [ ] 对比显示修改前后的差异
- [ ] AI解释每次修改的原因
- [ ] 支持多轮对话式调整
- [ ] 添加常用修改模板（降低预算、增加美食、亲子友好等）

## 测试建议

1. **基础测试**
   - 创建一个测试旅行计划
   - 输入："增加2个博物馆"
   - 验证AI是否正确添加了博物馆
   - 检查地图是否显示新景点

2. **预算测试**
   - 输入："住宿预算控制在200元/晚"
   - 验证所有酒店价格是否符合要求
   - 检查预算分析是否更新

3. **偏好测试**
   - 输入："我是素食主义者，推荐素食餐厅"
   - 验证所有餐厅推荐是否符合要求

4. **地图测试**
   - 修改任意景点
   - 验证地图上的标记是否正确更新
   - 检查路径是否重新规划

## 总结

AI智能修改功能为用户提供了一种更自然、更强大的方式来调整旅行计划。与手动编辑相比，它更适合大范围的调整和优化，同时确保修改后的行程依然合理可行。结合自动地图更新功能，为用户提供了完整、流畅的行程规划体验。

